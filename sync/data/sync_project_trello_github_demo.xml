<?xml version='1.0' encoding='UTF-8' ?>
<!-- Copyright 2020 Ivan Yelizariev <https://twitter.com/yelizariev>
     License MIT (https://opensource.org/licenses/MIT). -->
<odoo>
    <record id="trello-github_project" model="sync.project">
        <field name="name">Demo Trello-Github Integration</field>
        <field name="active" eval="True" />
        <field
            name="secret_code"
        ><![CDATA[# consts
GITHUB="github"
TRELLO="trello"


def _trello(secrets):
    for key in ["TRELLO_TOKEN", "TRELLO_KEY", "TRELLO_BOARD_ID"]:
        if not getattr(secrets, key):
            raise Exception("{} is not set".format(key))

    # https://github.com/sarumont/py-trello/tree/master/trello
    from trello import TrelloClient
    client = TrelloClient(
        api_key=secrets.TRELLO_KEY,
        api_secret=secrets.TRELLO_TOKEN,
    )
    board = client.get_board(secrets.TRELLO_BOARD_ID)

    # Webhook
    def set_webhook(url):
        pass

    # Trello cards
    def card_create(name, issue_id):
        description = "https://github.com/{}/issues/{}".format(secrets.GITHUB_REPO, issue_id)
        log_transmission(TRELLO, "create: {}".format([name, description]))
        card_list = board.open_lists()[0]
        card = card_list.add_card(name, description)
        return card.id

    def card_add_labels(card_id, tlabel_ids):
        log_transmission(TRELLO, "add labels to card#%s: %s" % (card_id, tlabel_ids))
        pass

    def card_remove_labels(card_id, tlabel_ids):
        log_transmission(TRELLO, "remove labels from card#%s: %s" % (card_id, tlabel_ids))
        pass

    def card_add_message(card_id, message):
        log_transmission(TRELLO, "add message to card#%s: %s" % (card_id, message))
        card = client.get_card(card_id)
        card.comment(message)

    # Trello labels
    def label_create(name):
        log_transmission(TRELLO, "create label: %s" % (name))
        return label_id

    def label_delete(tlabel_id):
        log_transmission(TRELLO, "delete label: %s" % (tlabel_id))
        pass

    def label_update(tlabel_id, new_name):
        log_transmission(TRELLO, "label#%s update: %s" % (tlabel_id, new_name))
        pass

    return {
        "set_webhook": set_webhook,
        "card_create": card_create,
        "card_add_labels": card_add_labels,
        "card_remove_labels": card_remove_labels,
        "card_add_message": card_add_message,
        "label_create": label_create,
        "label_delete": label_delete,
        "label_update": label_update,
    }


# Github
def _github(secrets):
    from github import Github
    if not secrets.GITHUB_TOKEN:
        raise Exception("github token is not set")
    if not secrets.GITHUB_REPO:
        raise Exception("github repo is not set")

    g = Github(secrets.GITHUB_TOKEN)
    repo = g.get_repo(secrets.GITHUB_REPO)

    # Github Webhook
    def set_webhook(url, events):
        # API: https://docs.github.com/en/rest/reference/repos#create-a-repository-webhook
        # Events: https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads
        config = {"url": url, "content_type": "json"}
        log_transmission(GITHUB, "set webhook: {}".format([config, events]))
        repo.create_hook("web", config, events)

    # Github Issues
    def issue_add_labels(issue_id, glabel_ids):
        pass

    def issue_remove_labels(issue_id, glabel_ids):
        pass

    # Github Labels
    def label_create(name):
        return glabel_id

    def label_delete(glabel_id):
        pass

    def label_update(glabel_id, new_name):
        pass

    return {
        "set_webhook": set_webhook,
        "issue_add_labels": issue_add_labels,
        "label_create": label_create,
        "label_delete": label_delete,
        "label_update": label_update,
    }

github = _github(secrets)
trello = _trello(secrets)

]]></field>
        <field
            name="common_code"
        ><![CDATA[

ISSUES_REL="TRELLO_GITHUB_ISSUES_REL"
LABELS_REL="TRELLO_GITHUB_LABELS_REL"

def get_related_label(from_id, name, from_system, to_system):
    elink = get_link(LABELS_REL, [(from_system, from_id), (to_system, None)])

    if elink:
        return elink.get(to_system)
    else:
        to_id = github_label_create(name) if to_system == GITHUB else trello_label_create(name)
        elink = set_link(LABELS_REL, [(from_system, from_id), (to_system, to_id)])
        return to_id

def github2trello_labels(labels):
    tlabel_ids = []
    for lb in labels:
        label_id = lb["id"]
        label_name = lb["name"]
        tlabel_id = get_related_label(label_id, label_name, from_system=GITHUB, to_system=TRELLO)
        tlabel_ids.append(tlabel_id)
    return tlabel_ids


        ]]></field>
    </record>
    <record id="trello-github_project_secret_github_token" model="sync.project.secret">
        <field name="key">GITHUB_TOKEN</field>
        <field name="description">
            Token with access to read issues and create webhooks, i.e. "repo" scope
        </field>
        <field name="url">
            https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token
        </field>
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-github_project_secret_github_repo" model="sync.project.secret">
        <field name="key">GITHUB_REPO</field>
        <field name="description">owner/repo_name</field>
        <field name="url" />
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-token_project-secret-parameter" model="sync.project.secret">
        <field name="key">TRELLO_TOKEN</field>
        <field name="description">
            Trello token to make API calls. Don't confuse it with API Key. Once you get
            API Key in https://trello.com/app-key page, you will see a link to generate
            token. Click one and you'll get the token
        </field>
        <field name="url">
            https://developer.atlassian.com/cloud/trello/guides/rest-api/api-introduction/
        </field>
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-key_project-secret-parameter" model="sync.project.secret">
        <field name="key">TRELLO_KEY</field>
        <field name="description" />
        <field name="url">https://trello.com/app-key</field>
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-board-id_project-secret-parameter" model="sync.project.secret">
        <field name="key">TRELLO_BOARD_ID</field>
        <field name="description">
            You can get one from the board url:
            https://trello.com/b/TRELLO_BOARD_ID/BOARD-NAME
        </field>
        <field name="url">
            https://community.atlassian.com/t5/Trello-questions/How-to-get-Trello-Board-ID/qaq-p/1347525
        </field>
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-github_project_param_prefix_name" model="sync.project.param">
        <field name="key">ISSUE_FROM_GITHUB_PREFIX</field>
        <field name="value">GITHUB:</field>
        <field name="description" />
        <field name="url" />
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-github_project_param_prefix_message" model="sync.project.param">
        <field name="key">MESSAGE_PREFIX</field>
        <field name="value">A Message posted on GitHub:</field>
        <field name="description" />
        <field name="url" />
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record
        id="trello-github_project_param_labels_merge_strategy"
        model="sync.project.param"
    >
        <field name="key">LABELS_MERGE_STRATEGY</field>
        <field name="value">UNION</field>
        <field name="description">
            Possible values:
USE_TRELLO, USE_GITHUB: use version from one side and override values from another
UNION: add missed labels to each side
INTERSECTION: remove labes that are not attached on another side
        </field>
        <field name="url" />
        <field name="project_id" ref="sync.trello-github_project" />
    </record>
    <record id="trello-github_task_setup" model="sync.task">
        <field name="name">Setup</field>
        <field name="active" eval="True" />
        <field name="project_id" ref="sync.trello-github_project" />
        <field
            name="code"
        ><![CDATA[
def handle_button():
    if trigger_name == "SETUP_GITHUB":
        github["set_webhook"](webhooks.GITHUB_ISSUE_UPDATES, ["issues"])
        github["set_webhook"](webhooks.GITHUB_ISSUE_COMMENT, ["issue_comment"])
        github["set_webhook"](webhooks.GITHUB_LABEL_UPDATES, ["label"])
    elif trigger_name == "SETUP_TRELLO":
        TODO
    else:
        raise Exception("Unknown button event: %s" % TRIGGER_NAME)

        ]]></field>
    </record>
    <record
        id="trello-github_task_setup_trigger_button_github"
        model="sync.trigger.button"
    >
        <field name="trigger_name">SETUP_GITHUB</field>
        <field name="name">Setup Github Webhook</field>
        <field name="sync_task_id" ref="sync.trello-github_task_setup" />
    </record>
    <record
        id="trello-github_task_setup_trigger_button_trello"
        model="sync.trigger.button"
    >
        <field name="trigger_name">SETUP_TRELLO</field>
        <field name="name">Setup Trello Webhook</field>
        <field name="sync_task_id" ref="sync.trello-github_task_setup" />
    </record>
    <record id="trello-github_task_issues" model="sync.task">
        <field name="name">Sync Github Issues to Trello (name, messages, labels)</field>
        <field name="active" eval="True" />
        <field name="project_id" ref="sync.trello-github_project" />
        <field
            name="code"
        ><![CDATA[

def handle_webhook(httprequest):
    data = json.loads(httprequest.data.decode())
    log("Github payload:\n{}".format(json.dumps(data, indent=4, sort_keys=True)))
    if data.get("zen"):
        # github sent dummy request to check webhook
        return "It Works!"
    if trigger_name == "GITHUB_ISSUE_COMMENT":
        return handle_webhook_issue_comment(data)
    elif trigger_name == "GITHUB_ISSUE_UPDATES":
        return handle_webhook_issues_update(data)
    else:
        raise Exception("Unknown trigger_name {}".format(trigger_name))

def handle_webhook_issue_comment(data):
    # https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#issue_comment
    if data["action"] not in ["created"]:
        # In this demo project we don't process other events
        return "thank you!"
    issue = data["issue"]
    issue_id = issue["number"]
    card_id = issue_id2card_id(issue_id)
    issue_message = data["comment"]["body"]
    message = "%s\n%s" % (params.MESSAGE_PREFIX, issue_message)
    trello["card_add_message"](card_id, message)

def handle_webhook_issues_update(data):
    # https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#issues
    if data["action"] not in ["opened", "labeled", "unlabeled"]:
        # In this demo project we don't process other events
        return "thank you!"
    issue = data["issue"]
    issue_id = issue["number"]
    issue_name = issue["title"]
    card_id = issue_id2card_id(issue_id)
    if not card_id:
        card_id = trello["card_create"](issue_name, issue_id)
        set_link(ISSUES_REL, {GITHUB: issue_id, TRELLO: card_id})

    issue_message = issue["body"]
    if issue_message:
        message = "%s\n%s" % (params.MESSAGE_PREFIX, issue_message)
        trello["card_add_message"](card_id, message)

    # attached labels:
    labels = []
    if data["action"] == "opened":
        labels = issue["labels"]
    if data["action"] == "labeled":
        labels = [data["label"]]
    if labels:
        tlabel_ids = github2trello_labels(labels)

        if tlabel_ids:
            trello["card_add_labels"](card_id, tlabel_ids)

    # detached labels:
    if data["action"] == "unlabeled":
        labels = [data["label"]]
        tlabel_ids = github2trello_labels(labels)

        if tlabel_ids:
            trello["card_remove_labels"](card_id, tlabel_ids)

def issue_id2card_id(issue_id):
    elink = get_link(ISSUES_REL, {GITHUB: issue_id, TRELLO: None})
    if elink:
        return elink.get(TRELLO)[0]

def handle_button():
    # Sync all existing open github issues to trello
    fetch_github_issues()

def fetch_github_issues(page=0):
    CHUNK_SIZE=10
    # fetch page
    TODO
    if not issues:
        return
    # split issues into chunks
    for TODO in TODO:
        chunk = TODO
        add_job("process_github_issues")(chunk)
    # fetch next page
    add_job("fetch_github_issues")(page+1)

def process_github_issues():
    # Should be similar to process a single issue (see handle_webhook)
    TODO


        ]]></field>
    </record>
    <record
        id="trello-github_task_issues_trigger_webhook_github"
        model="sync.trigger.webhook"
    >
        <field name="trigger_name">GITHUB_ISSUE_UPDATES</field>
        <field name="active" eval="True" />
        <field name="name">Github Issue updates</field>
        <field name="sync_task_id" ref="sync.trello-github_task_issues" />
    </record>
    <record id="github-issue-comment_webhook-trigger" model="sync.trigger.webhook">
        <field name="trigger_name">GITHUB_ISSUE_COMMENT</field>
        <field name="active" eval="True" />
        <field name="name">Webhook</field>
        <field name="sync_task_id" ref="sync.trello-github_task_issues" />
    </record>
    <record id="trello-github_task_cards" model="sync.task">
        <field name="name">Sync Trello Cards to Github (labels)</field>
        <field name="active" eval="True" />
        <field name="project_id" ref="sync.trello-github_project" />
        <field
            name="code"
        ><![CDATA[

def handle_webhook(httprequest):
    # Code is similar to github to trello sync
    pass

        ]]></field>
    </record>
    <record
        id="trello-github_task_issues_trigger_webhook_trello"
        model="sync.trigger.webhook"
    >
        <field name="trigger_name">TRELLO_CARD_UPDATES</field>
        <field name="active" eval="True" />
        <field name="name">Trello Card updates</field>
        <field name="sync_task_id" ref="sync.trello-github_task_cards" />
    </record>
    <record id="trello-github_task_labels" model="sync.task">
        <field name="name">Sync labels Updating/Deleting</field>
        <field name="active" eval="True" />
        <field name="project_id" ref="sync.trello-github_project" />
        <field
            name="code"
        ><![CDATA[

def handle_webhook(httprequest):
    glabel_id = None
    tlabel_id = None
    is_updated = None
    is_deleted = None
    if TRIGGER_NAME == "TRELLO_LABEL_UPDATES":
        tlabel_id = TODO
    elif TRIGGER_NAME == "GITHUB_LABEL_UPDATES":
        is_updated = httprequest.form["action"] == "edited"
        is_deleted = httprequest.form["action"] == "deleted"
        glabel_id = httprequest.form["label"]["id"]
    else:
       raise Exception("Unknown Event")

    elinks = search_links(LABELS_REL, {GITHUB: glabel_id, TRELLO: tlabel_id})
    if not elinks:
        # label is not linked
        return
    glabel_id = elinks[0].get(GITHUB)
    tlabel_id = elinks[0].get(TRELLO)
    if is_updated:
        if TRIGGER_NAME == "TRELLO_LABEL_UPDATES":
            github_label_update(glabel_id, new_name)
        else:
            trello_label_update(tlabel_id, new_name)

    if is_deleted:
        elinks.unlink()
        if TRIGGER_NAME == "TRELLO_LABEL_UPDATES":
            github_label_delete(glabel_id)
        else:
            trello_label_detele(tlabel_id)


        ]]></field>
    </record>
    <record
        id="trello-github_task_labels_trigger_webhook_trello"
        model="sync.trigger.webhook"
    >
        <field name="trigger_name">TRELLO_LABEL_UPDATES</field>
        <field name="active" eval="True" />
        <field name="name">Trello Label updates</field>
        <field name="sync_task_id" ref="sync.trello-github_task_labels" />
    </record>
    <record
        id="trello-github_task_labels_trigger_webhook_github"
        model="sync.trigger.webhook"
    >
        <field name="trigger_name">GITHUB_LABEL_UPDATES</field>
        <field name="active" eval="True" />
        <field name="name">Github Label updates</field>
        <field name="sync_task_id" ref="sync.trello-github_task_labels" />
    </record>
    <record id="trello-github_task_conflicts_resolving" model="sync.task">
        <field name="name">Labels Conflict Resolving</field>
        <field name="active" eval="True" />
        <field name="project_id" ref="sync.trello-github_project" />
        <field
            name="code"
        ><![CDATA[

def handle_cron():
    elinks = search_links(ISSUES_REL, {GITHUB: None, TRELLO: None})
    issue_ids = elinks.get(GITHUB)
    # https://docs.github.com/en/rest/reference/issues#list-repository-issues
    # issue is {id: int, labels: [{id: int, name: str, ...}]}
    issues = TODO
    # issue_id -> issue
    issues_index = TODO

    card_ids = elinks.get(TRELLO)
    # https://developer.atlassian.com/cloud/trello/rest/api-group-boards/#api-boards-id-cards-get
    # https://developer.atlassian.com/cloud/trello/rest/api-group-cards/#api-cards-id-get
    # card is dict {id: int, idLabels: [int], ...}
    cards = TODO
    # card_id -> card
    cards_index = TODO

    for el in elinks:
        card_id = el.get(TRELLO)
        issue_id = el.get(GITHUB)
        card = cards_index.get(card_id)
        issue = issues_index.get(issue_id)
        if not (card and issue):
            log("Linked card or issue is missed: %s" % (card, issue), level=LOG_WARNING)
            continue
        # compare labels
        tlabel_ids = card.idsLabels
        glabel_ids = [lbl["id"] for lbl in issue["labels"]]
        tlinks = search_links(LABELS_REL, {GITHUB: None, TRELLO: tlabel_ids})
        glinks = search_links(LABELS_REL, {GITHUB: glabel_ids, TRELLO: None})
        if tlinks == glinks:
            # all fine
            continue
        logs("Found labels mismatch: issue=%s, card=%s" % (issue["id"], card["id"]), level=LOG_DEBUG)

        tlinks_add = None
        tlinks_remove = None
        glinks_add = None
        glinks_remove = None
        if LABELS_MERGE_STRATEGY == "USE_TRELLO":
            glinks_add = tlinks - glinks
            glinks_remove = glinks - tlinks
        elif LABELS_MERGE_STRATEGY == "USE_GITHUB":
            tlinks_add = glinks - tlinks
            tlinks_remove = tlinks - glinks
        elif LABELS_MERGE_STRATEGY == "UNION":
            tlinks_add = glinks - tlinks
            glinks_add = tlinks - glinks
        elif LABELS_MERGE_STRATEGY == "INTERSECTION":
            tlinks_remove = tlinks - glinks
            glinks_remove = glinks - tlinks
        else:
            raise Exception("Unknown LABELS_MERGE_STRATEGY: %s" % LABELS_MERGE_STRATEGY, level=LOG_ERROR)

        if tlinks_add:
            trello_card_add_labels(card_id, tlinks_add.get(TRELLO))
        if glinks_add:
            github_issue_add_labels(card_id, glinks_add.get(GITHUB))
        if tlinks_remove:
            trello_card_remove_labels(card_id, tlinks_remove.get(TRELLO))
        if glinks_remove:
            github_issue_remove_labels(card_id, glinks_remove.get(GITHUB))


        ]]></field>
    </record>
    <record id="trello-github_task_conflicts_resolving_cron" model="sync.trigger.cron">
        <field name="trigger_name">CONFLICT_RESOLVING</field>
        <field name="active" eval="True" />
        <field name="sync_task_id" ref="sync.trello-github_task_conflicts_resolving" />
        <field name="interval_number">1</field>
        <field name="interval_type">days</field>
    </record>
</odoo>
